<!DOCTYPE html>
<html>
<head>
    <title>Flappy Horse</title>
    <style>
        body {
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial;
        }

        canvas {
            border: 3px solid #111;
            background: #70c5ce;
        }
    </style>
</head>

<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// Horse image
const trustyImg = new Image();
trustyImg.src = "../images/trusty.png";

// Player
let horse = {
    x: 80,
    y: 250,
    width: null, // placeholder, updated when image loads
    height: null,
    velocity: -3
};

let imageLoaded = false;

trustyImg.onload = () => {
    horse.width = trustyImg.width / 16;
    horse.height = trustyImg.height / 16;
    imageLoaded = true;
    loop();
};

const gravity = 0.18;
const jumpStrength = -6;

let gameOver = false;

// Pipes
let pipes = [];
const pipeGap = 275;
const pipeWidth = 65;
let frame = 0;
let score = 0;
let highScore = 0;

// Jump event
document.addEventListener("keydown", jump);
document.addEventListener("mousedown", jump);

function jump() {
    if (!gameOver) {
        horse.velocity = jumpStrength;
    } else {
        resetGame();
    }
}

function resetGame() {
    horse.y = 250;
    horse.velocity = -3;
    pipes = [];
    score = 0;
    frame = 0;
    gameOver = false;
}

// Create pipes
function createPipe() {
    let topHeight = Math.floor(Math.random() * 250) + 50;
    let bottomY = topHeight + pipeGap;

    pipes.push({
        x: canvas.width,
        topHeight: topHeight,
        bottomY: bottomY
    });
}

function drawHorse() {
    if (imageLoaded) {
        ctx.drawImage(trustyImg, horse.x, horse.y, horse.width, horse.height);
    } else {
        // fallback rectangle
        ctx.fillStyle = "red";
        ctx.fillRect(horse.x, horse.y, horse.width, horse.height);
    }
}

function drawPipes() {
    ctx.fillStyle = "green";
    pipes.forEach(pipe => {
        ctx.fillRect(pipe.x, 0, pipeWidth, pipe.topHeight); // top pipe
        ctx.fillRect(pipe.x, pipe.bottomY, pipeWidth, canvas.height - pipe.bottomY); // bottom pipe
    });
}

function checkCollision() {

    pipes.forEach(pipe => {
        let withinPipeX = horse.x + horse.width > pipe.x && horse.x < pipe.x + pipeWidth;
        let hitsTop = horse.y < pipe.topHeight;
        let hitsBottom = horse.y + horse.height > pipe.bottomY;

        if (withinPipeX && (hitsTop || hitsBottom)) {
            gameOver = true;
        }
    });
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (!gameOver) {
        frame++;
        horse.velocity += gravity;
        horse.y += horse.velocity;
        const floorY = canvas.height - horse.height;
        if (horse.y > floorY) {
            horse.y = floorY;
            horse.velocity = 0;
        }
        if (frame % 120 === 0) {
            createPipe();
        }

        pipes.forEach(pipe => pipe.x -= 2);

        // Remove off-screen pipes
        if (pipes.length && pipes[0].x < -pipeWidth) {
            pipes.shift();
            score++;
        }
    }

    drawHorse();
    drawPipes();
    checkCollision();

    // Score
    ctx.fillStyle = "white";
    ctx.font = "30px Arial";
    ctx.fillText(score, 20, 40);
    if (score > highScore){
        highScore = score
    }
    // Draw high score
    ctx.fillStyle = "yellow";
    ctx.font = "25px Arial";
    ctx.fillText("High: " + highScore, 20, 70);


    if (gameOver) {


        ctx.fillStyle = "black";
        ctx.font = "40px Arial";
        ctx.fillText("Game Over", 300, 300);
        ctx.font = "20px Arial";
        ctx.fillText("Press any key or click to restart", 263, 340);
    }

    requestAnimationFrame(loop);
}
</script>

</body>
</html>
